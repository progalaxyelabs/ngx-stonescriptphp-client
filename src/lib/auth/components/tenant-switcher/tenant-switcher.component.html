<div class="tenant-switcher-container">
  <!-- Error Message (Toast-style) -->
  <div *ngIf="hasError" class="error-toast">
    <span class="error-icon">⚠</span>
    <span class="error-text">{{ error?.message }}</span>
    <button type="button" class="error-close" (click)="clearError()" aria-label="Close error">×</button>
  </div>

  <!-- Dropdown Button -->
  <button
    type="button"
    class="dropdown-trigger"
    [class.loading]="isLoading"
    [disabled]="isLoading"
    (click)="toggleDropdown($event)"
    aria-haspopup="true"
    [attr.aria-expanded]="isDropdownOpen"
  >
    <!-- Current Tenant Logo -->
    <div class="trigger-logo">
      <img
        *ngIf="getCurrentTenantLogo()"
        [src]="getCurrentTenantLogo()"
        [alt]="getCurrentTenantName() + ' logo'"
        class="logo-image"
      />
      <div *ngIf="!getCurrentTenantLogo()" class="logo-placeholder">
        <span class="logo-initial">{{ currentMembership ? getTenantInitial(currentMembership) : '?' }}</span>
      </div>
    </div>

    <!-- Current Tenant Name -->
    <span class="trigger-text">{{ getCurrentTenantName() }}</span>

    <!-- Loading Spinner or Dropdown Arrow -->
    <span class="trigger-icon">
      <svg *ngIf="!isLoading" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span *ngIf="isLoading" class="spinner-small"></span>
    </span>
  </button>

  <!-- Dropdown Menu -->
  <div class="dropdown-menu" *ngIf="isDropdownOpen" [class.disabled]="isLoading">
    <!-- Tenant List -->
    <div class="dropdown-section">
      <div class="dropdown-header">Switch Organization</div>
      <button
        *ngFor="let membership of filteredMemberships"
        type="button"
        class="dropdown-item"
        [class.current]="isCurrentTenant(membership)"
        [class.inactive]="membership.status !== 'active'"
        [disabled]="isLoading || membership.status !== 'active'"
        (click)="onSwitchTenant(membership, $event)"
      >
        <!-- Tenant Logo -->
        <div class="item-logo">
          <img
            *ngIf="getTenantLogo(membership)"
            [src]="getTenantLogo(membership)"
            [alt]="getTenantName(membership) + ' logo'"
            class="logo-image"
          />
          <div *ngIf="!getTenantLogo(membership)" class="logo-placeholder">
            <span class="logo-initial">{{ getTenantInitial(membership) }}</span>
          </div>
        </div>

        <!-- Tenant Info -->
        <div class="item-info">
          <div class="item-name">{{ getTenantName(membership) }}</div>
          <div class="item-meta">
            <span [class]="getRoleBadgeClass(membership.role)">
              {{ getRoleLabel(membership.role) }}
            </span>
          </div>
        </div>

        <!-- Current Indicator (Checkmark) -->
        <div class="item-check" *ngIf="isCurrentTenant(membership)">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </button>

      <!-- Empty State -->
      <div *ngIf="filteredMemberships.length === 0" class="dropdown-empty">
        <p>No other organizations available</p>
      </div>
    </div>

    <!-- Open in New Tab Section -->
    <div class="dropdown-section dropdown-section-bordered" *ngIf="filteredMemberships.length > 0">
      <div class="dropdown-header">Quick Actions</div>
      <button
        *ngFor="let membership of filteredMemberships | slice:0:3"
        type="button"
        class="dropdown-item dropdown-item-secondary"
        [disabled]="isLoading"
        (click)="openInNewTab(membership, $event)"
      >
        <div class="item-icon">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 2H14V6M14 2L8 8M6 3H4C3.44772 3 3 3.44772 3 4V12C3 12.5523 3.44772 13 4 13H12C12.5523 13 13 12.5523 13 12V10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="item-info">
          <div class="item-name">{{ getTenantName(membership) }}</div>
          <div class="item-hint">Open in new tab</div>
        </div>
      </button>
    </div>
  </div>
</div>
